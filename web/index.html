<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDI Audio Monitor</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            box-sizing: border-box;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .monitor-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
            flex-wrap: wrap;
        }

        .widget-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .levels-widget-container {
            width: 150px;
        }

        h1 {
            margin-bottom: 0;
        }

        h2 {
            margin-bottom: 10px;
        }

        .level-meter-container {
            display: flex;
            flex-direction: row;
            gap: 5px;
            justify-content: center;
            height: 250px;
            align-items: flex-end;
        }

        .level-meter {
            width: 35px;
            height: 220px;
            border: 2px solid #34495e;
            background-color: #1c2833;
            border-radius: 5px;
            position: relative;
        }

        .meter-fill {
            width: 100%;
            height: 0%;
            background-color: #27ae60;
            position: absolute;
            left: 0;
            bottom: 0;
            border-radius: 2px;
        }

        .meter-peak-hold {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            opacity: 0;
            pointer-events: none;
            transform: translateY(1px);
            transition: opacity 0.15s ease;
        }

        .meter-label {
            position: absolute;
            bottom: -42px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .meter-current-value {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            color: #bdc3c7;
            font-size: 0.8em;
            font-weight: bold;
        }

        .scale-container {
            height: 220px;
            width: 30px;
            position: relative;
            color: #bdc3c7;
            font-size: 0.8em;
            text-align: right;
        }

        .scale-mark {
            position: absolute;
            width: 100%;
            border-bottom: 1px solid #4a627a;
            padding-right: 5px;
        }

        .vectorscope-container {
            width: 250px;
            height: 250px;
            border: 2px solid #34495e;
            background-color: #000;
            box-sizing: border-box;
        }

        .vectorscope-container img {
            width: 100%;
            height: 100%;
        }

        .lkfs-widget-container {
            width: 250px;
        }

        .lkfs-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #1c2833;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #34495e;
        }

        .lkfs-bar-widget-container {
            width: 200px;
        }

        .lkfs-bar-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .lkfs-bar-meter-container {
            display: flex;
            gap: 6px;
            align-items: flex-end;
            justify-content: center;
            width: 100%;
            height: 250px;
        }

        .lkfs-bar-scale {
            height: 220px;
            width: 30px;
            position: relative;
            color: #bdc3c7;
            font-size: 0.8em;
            text-align: right;
        }

        .lkfs-bar-stack {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 220px;
            width: 35px;
            position: relative;
        }

        .lkfs-bar-meter {
            width: 35px;
            height: 220px;
            border: 2px solid #34495e;
            background-color: #1c2833;
            border-radius: 5px;
            position: relative;
        }

        .lkfs-bar-fill {
            width: 100%;
            height: 0%;
            background-color: #27ae60;
            position: absolute;
            left: 0;
            bottom: 0;
            border-radius: 3px;
        }

        .lkfs-bar-current-value {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            color: #bdc3c7;
            font-size: 0.8em;
            font-weight: bold;
        }

        .lkfs-bar-label {
            position: absolute;
            bottom: -42px;
            left: 50%;
            transform: translateX(-50%);
            color: #ecf0f1;
            font-size: 0.9em;
            font-weight: bold;
        }

        .lra-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background-color: #1c2833;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #34495e;
            justify-content: center;
        }

        .lkfs-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em;
        }

        .lkfs-label {
            font-weight: bold;
            color: #bdc3c7;
        }

        .lkfs-value {
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }

        #toggleIntegration,
        .placeholder-button {
            background-color: #34495e;
            color: #ecf0f1;
            border: 1px solid #4a627a;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }

        #toggleIntegration:hover {
            background-color: #4a627a;
        }

        .placeholder-button {
            visibility: hidden;
        }

        .lra-bar-container {
            width: 100%;
            height: 10px;
            background-color: #2c3e50;
            border-radius: 3px;
            margin-top: 5px;
            position: relative;
        }

        .lra-bar {
            height: 100%;
            width: 0%;
            background-color: #3498db;
            border-radius: 3px;
        }

        .eq-widget-container {
            width: 500px;
        }

        #eqCanvas {
            border: 2px solid #34495e;
            background-color: #1c2833;
            border-radius: 5px;
        }

        .correlator-container {
            width: 250px;
            height: 25px;
            border: 2px solid #34495e;
            background-color: #1c2833;
            border-radius: 5px;
            position: relative;
            margin-top: 10px;
        }

        .correlator-bar {
            position: absolute;
            width: 0;
            height: 100%;
            background-color: #27ae60;
            left: 50%;
            border-radius: 2px;
        }

        .correlator-scale {
            width: 250px;
            display: flex;
            justify-content: space-between;
            position: relative;
            top: 5px;
            font-size: 0.8em;
            color: #bdc3c7;
            padding: 0 5px;
            box-sizing: border-box;
        }

        /* Settings Menu Styles */
        .settings-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .settings-content {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            background-color: #34495e;
            border-radius: 5px;
            padding: 10px;
        }

        #settings-toggle {
            background: none;
            border: none;
            color: #ecf0f1;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            background-color: #34495e;
            border-radius: 5px;
        }

        .channel-selector {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .channel-selector label {
            font-size: 0.9em;
        }

        .channel-selector select {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 1px solid #4a627a;
            border-radius: 3px;
            padding: 5px;
        }

        #save-settings {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        #save-settings:hover {
            background-color: #2ecc71;
        }

        /* Status Display Styles */
        .status-display {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        #status-toggle {
            background-color: #34495e;
            color: #ecf0f1;
            border: 1px solid #4a627a;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
        }

        #status-content {
            display: none;
            background-color: #1c2833;
            border: 2px solid #34495e;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 5px;
            width: 200px;
            font-size: 0.9em;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .status-row span:last-child {
            text-align: right;
        }

        /* Tab Styles */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #34495e;
            width: 90%;
            max-width: 1200px;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            background-color: transparent;
            color: #bdc3c7;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1.1em;
            text-decoration: none;
        }

        .tab-btn.active {
            color: #ecf0f1;
            border-bottom: 3px solid #3498db;
        }

        /* Settings Menu All Channel Meters */
        .all-channel-meters-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .small-meter-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .small-meter {
            width: 10px;
            height: 60px;
            border: 1px solid #4a627a;
            background-color: #1c2833;
            position: relative;
            border-radius: 2px;
        }

        .small-meter-fill {
            width: 100%;
            height: 0%;
            background-color: #27ae60;
            position: absolute;
            bottom: 0;
            border-radius: 1px;
        }

        .small-meter-label {
            font-size: 0.7em;
            text-align: center;
            color: #bdc3c7;
        }
    </style>
</head>

<body>
    <div class="settings-menu">
        <button id="settings-toggle">⚙️</button>
        <div id="settings-content" class="settings-content">
            <h3>Channel Settings</h3>
            <div id="all-channel-meters"></div>
            <div class="channel-selector">
                <label for="left-channel">Left Channel:</label>
                <select id="left-channel"></select>
            </div>
            <div class="channel-selector">
                <label for="right-channel">Right Channel:</label>
                <select id="right-channel"></select>
            </div>
            <button id="save-settings">Save & Restart</button>
        </div>
    </div>

    <div class="main-container">
        <h1><span style="position:relative;"><span
                    style="font-size: 0.5em; color: #bdc3c7; position: absolute; right: 100%; white-space: nowrap; top: 50%; transform: translateY(-50%); margin-right: 1ch;">ducky's</span>
                Ch Sixth Sense </span></h1>

        <div class="tab-nav">
            <a href="/" class="tab-btn active">Audio</a>
            <a href="/video.html" class="tab-btn">Video</a>
        </div>

        <div id="audio-tab-content">
            <div class="monitor-row">
                <div class="widget-container levels-widget-container">
                    <h2>Levels</h2>
                    <div class="level-meter-container">
                        <div class="scale-container" id="meterScale"></div>
                        <div class="level-meter">
                            <div class="meter-fill" id="leftMeterFill"></div>
                            <div class="meter-peak-hold" id="leftPeakHold"></div>
                            <span class="meter-current-value" id="leftMeterValue">-inf</span>
                            <span class="meter-label">L</span>
                        </div>
                        <div class="level-meter">
                            <div class="meter-fill" id="rightMeterFill"></div>
                            <div class="meter-peak-hold" id="rightPeakHold"></div>
                            <span class="meter-current-value" id="rightMeterValue">-inf</span>
                            <span class="meter-label">R</span>
                        </div>
                    </div>
                </div>

                <div class="widget-container lkfs-widget-container">
                    <h2>LKFS</h2>
                    <div class="lkfs-display">
                        <div class="lkfs-row">
                            <span class="lkfs-label">M :</span>
                            <span class="lkfs-value" id="momentaryValue">-inf</span>
                            <button class="placeholder-button">Start</button>
                        </div>
                        <div class="lkfs-row">
                            <span class="lkfs-label">S :</span>
                            <span class="lkfs-value" id="shortTermValue">-inf</span>
                            <button class="placeholder-button">Start</button>
                        </div>
                        <div class="lkfs-row">
                            <span class="lkfs-label">I :</span>
                            <span class="lkfs-value" id="integratedValue">-inf</span>
                            <button id="toggleIntegration">Start</button>
                        </div>
                    </div>
                </div>

                <div class="widget-container lkfs-bar-widget-container">
                    <h2>LKFS Bar</h2>
                    <div class="lkfs-bar-display">
                        <div class="lkfs-bar-meter-container">
                            <div class="lkfs-bar-scale" id="lkfsMeterScale"></div>
                            <div class="lkfs-bar-stack">
                                <div class="lkfs-bar-meter">
                                    <div class="lkfs-bar-fill" id="momentaryBar"></div>
                                    <span class="lkfs-bar-current-value" id="momentaryBarValueDisplay">-inf</span>
                                    <span class="lkfs-bar-label">M</span>
                                </div>
                            </div>
                            <div class="lkfs-bar-stack">
                                <div class="lkfs-bar-meter">
                                    <div class="lkfs-bar-fill" id="shortTermBar"></div>
                                    <span class="lkfs-bar-current-value" id="shortTermBarValueDisplay">-inf</span>
                                    <span class="lkfs-bar-label">S</span>
                                </div>
                            </div>
                            <div class="lkfs-bar-stack">
                                <div class="lkfs-bar-meter">
                                    <div class="lkfs-bar-fill" id="integratedBar"></div>
                                    <span class="lkfs-bar-current-value" id="integratedBarValueDisplay">-inf</span>
                                    <span class="lkfs-bar-label">I</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="widget-container">
                    <h2>Correlator</h2>
                    <div class="correlator-container">
                        <div class="correlator-bar" id="correlatorBar"></div>
                    </div>
                    <div class="correlator-scale">
                        <span>-</span>
                        <span>0</span>
                        <span>+</span>
                    </div>
                </div>

                <div class="widget-container lkfs-widget-container">
                    <h2>LRA</h2>
                    <div class="lra-display">
                        <div class="lkfs-row">
                            <div style="flex-basis: 100%;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em;">
                                    <span class="lkfs-label">LRA:</span>
                                    <span class="lkfs-value" id="lraValue" style="font-size: 1em;">0.0</span>
                                </div>
                                <div class="lra-bar-container">
                                    <div class="lra-bar" id="lraBar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="widget-container">
                    <h2>Vectorscope</h2>
                    <div class="vectorscope-container">
                        <img id="vectorscopeImage" alt="Vectorscope Stream">
                    </div>
                </div>
            </div>
            <div class="monitor-row">
                <div class="widget-container eq-widget-container">
                    <h2>EQ Meter</h2>
                    <canvas id="eqCanvas" width="500" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="status-display">
        <div id="status-content">
            <div class="status-row">
                <span>CPU:</span>
                <span id="cpu-usage">-</span>
            </div>
            <div class="status-row">
                <span>Memory:</span>
                <span id="mem-usage">-</span>
            </div>
        </div>
        <button id="status-toggle">Status</button>
    </div>

    <script>
        const leftMeterFill = document.getElementById('leftMeterFill');
        const rightMeterFill = document.getElementById('rightMeterFill');
        const leftMeterValue = document.getElementById('leftMeterValue');
        const rightMeterValue = document.getElementById('rightMeterValue');
        const leftPeakHold = document.getElementById('leftPeakHold');
        const rightPeakHold = document.getElementById('rightPeakHold');
        const meterScale = document.getElementById('meterScale');
        const momentaryValue = document.getElementById('momentaryValue');
        const shortTermValue = document.getElementById('shortTermValue');
        const integratedValue = document.getElementById('integratedValue');
        const lraValue = document.getElementById('lraValue');
        const lraBar = document.getElementById('lraBar');
        const toggleBtn = document.getElementById('toggleIntegration');
        const eqCanvas = document.getElementById('eqCanvas');
        const eqCtx = eqCanvas.getContext('2d');
        const correlatorBar = document.getElementById('correlatorBar');
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsContent = document.getElementById('settings-content');
        const leftChannelSelect = document.getElementById('left-channel');
        const rightChannelSelect = document.getElementById('right-channel');
        const saveSettingsBtn = document.getElementById('save-settings');
        const statusToggle = document.getElementById('status-toggle');
        const statusContent = document.getElementById('status-content');
        const cpuUsageSpan = document.getElementById('cpu-usage');
        const memUsageSpan = document.getElementById('mem-usage');
        const lkfsMeterScale = document.getElementById('lkfsMeterScale');
        const momentaryBar = document.getElementById('momentaryBar');
        const shortTermBar = document.getElementById('shortTermBar');
        const integratedBar = document.getElementById('integratedBar');
        const momentaryBarValueDisplay = document.getElementById('momentaryBarValueDisplay');
        const shortTermBarValueDisplay = document.getElementById('shortTermBarValueDisplay');
        const integratedBarValueDisplay = document.getElementById('integratedBarValueDisplay');
        const vectorscopeImage = document.getElementById('vectorscopeImage');

        let isIntegrating = false;
        let vectorscopeObjectUrl = null;

        function updateVectorscopeImage(blob) {
            if (!vectorscopeImage) return;
            if (vectorscopeObjectUrl) {
                URL.revokeObjectURL(vectorscopeObjectUrl);
                vectorscopeObjectUrl = null;
            }
            vectorscopeObjectUrl = URL.createObjectURL(blob);
            vectorscopeImage.src = vectorscopeObjectUrl;
        }

        const ws = new WebSocket(`ws://${window.location.host}/?role=sub&page=audio`);
        ws.binaryType = 'blob';

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            ws.send(JSON.stringify({
                command: 'get_settings'
            }));
        };

        ws.onmessage = async (event) => {
            if (typeof event.data !== "string") {
                const blob = event.data instanceof Blob ? event.data : new Blob([event.data], { type: 'image/jpeg' });
                updateVectorscopeImage(blob);
                return;
            }

            try {
                const data = JSON.parse(event.data);

                if (data.type === 'settings') {
                    leftChannelSelect.value = data.leftAudioChannel;
                    rightChannelSelect.value = data.rightAudioChannel;
                }

                if (data.type === 'system_stats') {
                    cpuUsageSpan.textContent = `${data.cpu.toFixed(1)}%`;
                    const memUsedGb = data.memory.used / (1024 ** 3);
                    const memTotalGb = data.memory.total / (1024 ** 3);
                    memUsageSpan.innerHTML =
                        `${data.memory.percent.toFixed(1)}%<br><small>(${memUsedGb.toFixed(2)}/${memTotalGb.toFixed(2)} GB)</small>`;
                }

                if (data.type === 'integration_state') {
                    isIntegrating = data.is_integrating;
                    if (isIntegrating) {
                        toggleBtn.textContent = 'Stop';
                        toggleBtn.style.backgroundColor = '#e74c3c';
                    } else {
                        toggleBtn.textContent = 'Start';
                        toggleBtn.style.backgroundColor = '#34495e';
                    }
                }

                if (data.type === 'levels') {
                    meterState.left.latestValue = data.left;
                    meterState.right.latestValue = data.right;

                    if (data.all && Array.isArray(data.all)) {
                        data.all.forEach((db, index) => {
                            const meterFill = document.getElementById(`settings-meter-${index}`);
                            if (meterFill) {
                                const percentage = dbToPercentage(db);
                                meterFill.style.height = `${percentage}%`;
                                if (db > -6) meterFill.style.backgroundColor = '#e74c3c';
                                else if (db > -12) meterFill.style.backgroundColor = '#f1c40f';
                                else meterFill.style.backgroundColor = '#27ae60';
                            }
                        });
                    }
                }

                if (data.type === 'correlation') {
                    correlatorState.latestValue = data.value;
                }

                if (data.type === 'eq') {
                    for (let i = 0; i < numEqBands; i++) {
                        if (data.data && data.data[i] !== undefined) {
                            eqState.bands[i].latestValue = data.data[i];
                        }
                    }
                }

                if (data.type === 'lkfs') {
                    handleLkfsUpdate('momentary', data.value, momentaryValue);
                }

                if (data.type === 's_lkfs') {
                    handleLkfsUpdate('shortTerm', data.value, shortTermValue);
                }

                if (data.type === 'i_lkfs') {
                    handleLkfsUpdate('integrated', data.value, integratedValue);
                }

                if (data.type === 'lra') {
                    const currentLra = data.value;
                    lraValue.textContent = currentLra.toFixed(1);
                    const lraPercentage = Math.min(100, (currentLra / 25) * 100);
                    lraBar.style.width = `${lraPercentage}%`;
                }

            } catch (e) {
                console.error('Error parsing message:', e);
            }
        };

        ws.onclose = () => {
            console.log('Disconnected from WebSocket server');
            momentaryValue.textContent = 'N/A';
            shortTermValue.textContent = 'N/A';
            integratedValue.textContent = 'N/A';
            lraValue.textContent = 'N/A';
            setLkfsFallbackLabel('N/A');
            if (vectorscopeObjectUrl) {
                URL.revokeObjectURL(vectorscopeObjectUrl);
                vectorscopeObjectUrl = null;
            }
        };

        ws.onerror = error => {
            console.error('WebSocket Error:', error);
            momentaryValue.textContent = 'Error';
            shortTermValue.textContent = 'Error';
            integratedValue.textContent = 'Error';
            lraValue.textContent = 'Error';
            setLkfsFallbackLabel('Error');
        };

        window.addEventListener('beforeunload', () => {
            if (vectorscopeObjectUrl) {
                URL.revokeObjectURL(vectorscopeObjectUrl);
                vectorscopeObjectUrl = null;
            }
        });

        toggleBtn.onclick = () => {
            const command = isIntegrating ? 'stop_integration' : 'start_integration';
            ws.send(JSON.stringify({
                command: command
            }));
            console.log('Sent command: ' + command);
        };

        function populateChannelSelectors() {
            const allMetersContainer = document.getElementById('all-channel-meters');
            allMetersContainer.className = 'all-channel-meters-container';

            for (let i = 0; i < 16; i++) {
                const optionL = document.createElement('option');
                optionL.value = i;
                optionL.textContent = `Channel ${i + 1}`;
                leftChannelSelect.appendChild(optionL);
                const optionR = document.createElement('option');
                optionR.value = i;
                optionR.textContent = `Channel ${i + 1}`;
                rightChannelSelect.appendChild(optionR);

                const meterWrapper = document.createElement('div');
                meterWrapper.className = 'small-meter-wrapper';
                const meterLabel = document.createElement('div');
                meterLabel.className = 'small-meter-label';
                meterLabel.textContent = i + 1;
                const meterDiv = document.createElement('div');
                meterDiv.className = 'small-meter';
                const meterFill = document.createElement('div');
                meterFill.className = 'small-meter-fill';
                meterFill.id = `settings-meter-${i}`;
                meterDiv.appendChild(meterFill);
                meterWrapper.appendChild(meterDiv);
                meterWrapper.appendChild(meterLabel);
                allMetersContainer.appendChild(meterWrapper);
            }
        }

        settingsToggle.onclick = () => {
            const isDisplayed = settingsContent.style.display === 'flex';
            settingsContent.style.display = isDisplayed ? 'none' : 'flex';
        };

        saveSettingsBtn.onclick = () => {
            const leftChannel = leftChannelSelect.value;
            const rightChannel = rightChannelSelect.value;
            fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        leftChannel,
                        rightChannel
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Settings saved:', data);
                    alert('Settings saved and Capture process restarted.');
                    settingsContent.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    alert('Error saving settings.');
                });
        };

        populateChannelSelectors();

        statusToggle.onclick = () => {
            const isDisplayed = statusContent.style.display === 'block';
            statusContent.style.display = isDisplayed ? 'none' : 'block';
        };

        const minDb = -60.0,
            maxDb = 0.0,
            minDbEq = -40.0,
            maxDbEq = 5.0,
            minLkfs = -40.0,
            maxLkfs = -18.0;
        let meterState = {
            left: {
                latestValue: minDb,
                displayValue: minDb,
                peakHoldValue: minDb,
                peakHoldTimer: 0
            },
            right: {
                latestValue: minDb,
                displayValue: minDb,
                peakHoldValue: minDb,
                peakHoldTimer: 0
            }
        };
        const numEqBands = 64;
        let eqState = {
            bands: Array.from({
                length: numEqBands
            }, () => ({
                latestValue: minDbEq,
                displayValue: minDbEq
            }))
        };
        let correlatorState = {
            latestValue: 0,
            displayValue: 0
        };
        let lkfsState = {
            momentary: {
                latestValue: minLkfs,
                displayValue: minLkfs,
                label: '-inf'
            },
            shortTerm: {
                latestValue: minLkfs,
                displayValue: minLkfs,
                label: '-inf'
            },
            integrated: {
                latestValue: minLkfs,
                displayValue: minLkfs,
                label: '-inf'
            }
        };
        const lkfsMeterElements = {
            momentary: {
                bar: momentaryBar,
                label: momentaryBarValueDisplay
            },
            shortTerm: {
                bar: shortTermBar,
                label: shortTermBarValueDisplay
            },
            integrated: {
                bar: integratedBar,
                label: integratedBarValueDisplay
            }
        };
        const lkfsScalePoints = [-18, -20, -22, -24, -26, -30, -35, -40];

        function dbToPercentage(db) {
            let percentage = ((db - minDb) / (maxDb - minDb)) * 100;
            return Math.max(0, Math.min(100, percentage));
        }

        function createScale(container, scalePoints = [0, -6, -12, -18, -24, -30, -40, -50, -60], mapper = dbToPercentage) {
            if (!container) return;
            container.innerHTML = '';
            scalePoints.forEach(db => {
                const mark = document.createElement('div');
                mark.className = 'scale-mark';
                const percentage = mapper(db);
                mark.style.bottom = `${percentage}%`;
                mark.innerHTML = `<span>${db}</span>`;
                container.appendChild(mark);
            });
        }

        function updateMeterDOM(fillElement, dbValue) {
            if (!fillElement) return;
            const percentage = dbToPercentage(dbValue);
            fillElement.style.height = `${percentage}%`;
            if (dbValue > -6) fillElement.style.backgroundColor = '#e74c3c';
            else if (dbValue > -12) fillElement.style.backgroundColor = '#f1c40f';
            else fillElement.style.backgroundColor = '#27ae60';
        }

        function updatePeakHoldIndicator(entry, peakElement, deltaSeconds) {
            if (!entry) return;
            entry.peakHoldTimer = Math.max(0, entry.peakHoldTimer - deltaSeconds);
            if (entry.latestValue > entry.peakHoldValue) {
                entry.peakHoldValue = entry.latestValue;
                entry.peakHoldTimer = peakHoldDuration;
            } else if (entry.peakHoldTimer === 0 && entry.peakHoldValue > entry.displayValue) {
                entry.peakHoldValue = entry.displayValue;
            }
            if (peakElement) {
                const percentage = dbToPercentage(entry.peakHoldValue);
                peakElement.style.bottom = `${percentage}%`;
                peakElement.style.opacity = percentage <= 0 ? '0' : '1';
            }
        }

        function lkfsDbToPercentage(db) {
            let percentage = ((db - minLkfs) / (maxLkfs - minLkfs)) * 100;
            return Math.max(0, Math.min(100, percentage));
        }

        function updateLkfsMeter(fillElement, dbValue) {
            if (!fillElement) return;
            const percentage = lkfsDbToPercentage(dbValue);
            fillElement.style.height = `${percentage}%`;
            if (dbValue >= -22) fillElement.style.backgroundColor = '#e74c3c';
            else fillElement.style.backgroundColor = '#27ae60';
        }

        function handleLkfsUpdate(key, value, textElement) {
            const entry = lkfsState[key];
            if (!entry) return;
            if (Number.isFinite(value)) {
                const clamped = Math.min(Math.max(value, minLkfs), maxLkfs);
                entry.latestValue = clamped;
                entry.label = value.toFixed(1);
                if (textElement) textElement.textContent = value.toFixed(2);
            } else {
                entry.latestValue = minLkfs;
                entry.displayValue = minLkfs;
                entry.label = '-inf';
                if (textElement) textElement.textContent = '-inf';
            }
            const meter = lkfsMeterElements[key];
            if (meter && meter.label) meter.label.textContent = entry.label;
        }

        function setLkfsFallbackLabel(labelText) {
            Object.keys(lkfsState).forEach(key => {
                const entry = lkfsState[key];
                entry.latestValue = minLkfs;
                entry.displayValue = minLkfs;
                entry.label = labelText;
                const meter = lkfsMeterElements[key];
                if (meter) {
                    if (meter.label) meter.label.textContent = labelText;
                    if (meter.bar) {
                        meter.bar.style.height = '0%';
                        meter.bar.style.backgroundColor = '#27ae60';
                    }
                }
            });
        }

        function drawEq() {
            const canvas = eqCtx.canvas,
                axisYWidth = 30,
                axisXHeight = 20;
            const meterWidth = canvas.width - axisYWidth,
                meterHeight = canvas.height - axisXHeight;
            eqCtx.clearRect(0, 0, canvas.width, canvas.height);
            eqCtx.save();
            eqCtx.translate(axisYWidth, 0);
            const barWidth = meterWidth / numEqBands;
            for (let i = 0; i < numEqBands; i++) {
                const db = eqState.bands[i].displayValue;
                const percent = (db - minDbEq) / (maxDbEq - minDbEq);
                const barHeight = Math.max(0, meterHeight * percent);
                if (db > 0) eqCtx.fillStyle = '#e74c3c';
                else if (db > -9) eqCtx.fillStyle = '#f1c40f';
                else eqCtx.fillStyle = '#27ae60';
                const x = i * barWidth;
                const y = meterHeight - barHeight;
                eqCtx.fillRect(x, y, barWidth - 1, barHeight);
            }
            eqCtx.fillStyle = '#bdc3c7';
            eqCtx.font = '10px sans-serif';
            eqCtx.textAlign = 'center';
            const freqLabels = [30, 60, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
            const min_log_freq = Math.log(20),
                max_log_freq = Math.log(20000),
                log_range = max_log_freq - min_log_freq;
            freqLabels.forEach(freq => {
                const log_freq = Math.log(freq);
                const x = meterWidth * (log_freq - min_log_freq) / log_range;
                eqCtx.fillText(freq < 1000 ? freq : `${freq / 1000}k`, x, canvas.height - 5);
            });
            eqCtx.restore();
            eqCtx.save();
            eqCtx.fillStyle = '#bdc3c7';
            eqCtx.font = '10px sans-serif';
            eqCtx.textAlign = 'right';
            const dbLabels = [0, -9, -18, -27, -36];
            dbLabels.forEach(db => {
                const percent = (db - minDbEq) / (maxDbEq - minDbEq);
                const y = meterHeight - (meterHeight * percent);
                eqCtx.fillText(db, axisYWidth - 8, y + 3);
                eqCtx.strokeStyle = '#4a627a';
                eqCtx.beginPath();
                eqCtx.moveTo(axisYWidth - 4, y);
                eqCtx.lineTo(canvas.width, y);
                eqCtx.stroke();
            });
            eqCtx.restore();
        }

        let lastFrameTime = performance.now();
        const fallRate = 15;
        const peakHoldDuration = 3;
        const lkfsFallRate = fallRate * (maxLkfs - minLkfs) / (maxDb - minDb);

        function animationLoop(currentTime) {
            const deltaTime = currentTime - lastFrameTime;
            const deltaSeconds = deltaTime / 1000;
            lastFrameTime = currentTime;
            let leftState = meterState.left;
            if (leftState.latestValue > leftState.displayValue) leftState.displayValue = leftState.latestValue;
            else leftState.displayValue = Math.max(leftState.displayValue - fallRate * deltaSeconds, minDb);
            let rightState = meterState.right;
            if (rightState.latestValue > rightState.displayValue) rightState.displayValue = rightState.latestValue;
            else rightState.displayValue = Math.max(rightState.displayValue - fallRate * deltaSeconds, minDb);
            updateMeterDOM(leftMeterFill, leftState.displayValue);
            updateMeterDOM(rightMeterFill, rightState.displayValue);
            updatePeakHoldIndicator(leftState, leftPeakHold, deltaSeconds);
            updatePeakHoldIndicator(rightState, rightPeakHold, deltaSeconds);
            leftMeterValue.textContent = leftState.displayValue.toFixed(1);
            rightMeterValue.textContent = rightState.displayValue.toFixed(1);
            ['momentary', 'shortTerm', 'integrated'].forEach(key => {
                const entry = lkfsState[key];
                const meter = lkfsMeterElements[key];
                if (!entry || !meter || !meter.bar) return;
                if (entry.latestValue > entry.displayValue) {
                    entry.displayValue = entry.latestValue;
                } else {
                    entry.displayValue = Math.max(entry.displayValue - lkfsFallRate * (deltaTime / 1000), minLkfs);
                }
                updateLkfsMeter(meter.bar, entry.displayValue);
            });
            for (let i = 0; i < numEqBands; i++) {
                let band = eqState.bands[i];
                if (band.latestValue > band.displayValue) band.displayValue = band.latestValue;
                else band.displayValue = Math.max(band.displayValue - fallRate * (deltaTime / 1000), minDbEq);
            }
            drawEq();
            const corrFallRate = 2.0,
                decay = corrFallRate * (deltaTime / 1000);
            if (Math.abs(correlatorState.latestValue) > Math.abs(correlatorState.displayValue)) correlatorState.displayValue =
                correlatorState.latestValue;
            if (correlatorState.displayValue > 0) correlatorState.displayValue = Math.max(0, correlatorState.displayValue -
                decay);
            else if (correlatorState.displayValue < 0) correlatorState.displayValue = Math.min(0, correlatorState.displayValue +
                decay);
            if (Math.abs(correlatorState.latestValue) > Math.abs(correlatorState.displayValue)) correlatorState.displayValue =
                correlatorState.latestValue;
            if (correlatorBar) {
                const displayValue = correlatorState.displayValue;
                if (displayValue >= 0) {
                    correlatorBar.style.left = '50%';
                    correlatorBar.style.width = (displayValue * 50) + '%';
                } else {
                    const width = -displayValue * 50;
                    correlatorBar.style.left = (50 - width) + '%';
                    correlatorBar.style.width = width + '%';
                }
            }
            requestAnimationFrame(animationLoop);
        }

        createScale(meterScale);
        createScale(lkfsMeterScale, lkfsScalePoints, lkfsDbToPercentage);
        requestAnimationFrame(animationLoop);
    </script>
</body>

</html>
