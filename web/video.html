<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDI Video Monitor</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            box-sizing: border-box;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .monitor-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
            flex-wrap: wrap;
        }

        .widget-container {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            margin-bottom: 0;
        }

        h2 {
            margin-bottom: 10px;
        }

        .video-container {
            width: 640px;
            height: 360px;
            border: 2px solid #34495e;
            background-color: #000;
            box-sizing: border-box;
        }

        .video-container video {
            width: 100%;
            height: 100%;
        }

        .videovs-container {
            width: 250px;
            height: 250px;
            border: 2px solid #34495e;
            background-color: #000;
            box-sizing: border-box;
            position: relative;
        }

        .videovs-container video {
            width: 100%;
            height: 100%;
        }

        #videoVectorscopeGrid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Tab Styles */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #34495e;
            width: 90%;
            max-width: 1200px;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            background-color: transparent;
            color: #bdc3c7;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1.1em;
            text-decoration: none;
        }

        .tab-btn.active {
            color: #ecf0f1;
            border-bottom: 3px solid #3498db;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <h1><span style="position:relative;"><span style="font-size: 0.5em; color: #bdc3c7; position: absolute; right: 100%; white-space: nowrap; top: 50%; transform: translateY(-50%); margin-right: 1ch;">ducky's</span> Ch Six Sense </span></h1>

        <div class="tab-nav">
            <a href="/audio" class="tab-btn">Audio</a>
            <a href="/video" class="tab-btn active">Video</a>
        </div>

        <div id="video-content">
            <div class="monitor-row">
                <div class="widget-container">
                    <h2>Video</h2>
                    <div class="video-container">
                        <video id="rawVideo" autoplay playsinline muted></video>
                    </div>
                </div>
                <div class="widget-container">
                    <h2>Video Waveform</h2>
                    <div class="video-container">
                        <video id="waveformVideo" autoplay playsinline muted></video>
                    </div>
                </div>
            </div>
            <div class="monitor-row">
                <div class="widget-container">
                    <h2>Video Vectorscope</h2>
                    <div class="videovs-container">
                        <video id="vectorscopeVideo" autoplay playsinline muted></video>
                        <canvas id="videoVectorscopeGrid"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- WebRTC Globals ---
        
        const pc = new RTCPeerConnection();
        let makingAnswer = false;
        let pendingRemoteOffer = null;
        let currentPubId = null;
        const pendingIceCandidates = [];

        // --- WebSocket connection (now with role=sub and page=video) ---
        
        const ws = new WebSocket(`ws://${window.location.host}/?role=sub&page=video`);

        // --- WebRTC Functions ---
        
        const handleOffer = async (sdp) => {
            if (makingAnswer) {
                pendingRemoteOffer = sdp;
                return;
            }
            makingAnswer = true;

            try {
                if (pc.signalingState !== "stable") {
                    try {
                        await pc.setLocalDescription({ type: "rollback" });
                    } catch (e) {
                        console.warn("Rollback failed (this is often fine)", e);
                    }
                }

                await pc.setRemoteDescription({ type: "offer", sdp });

                let vtrans = pc.getTransceivers().find(t => t.receiver && t.receiver.track?.kind === "video");
                if (!vtrans) {
                    vtrans = pc.addTransceiver("video", { direction: "recvonly" });
                }

                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp, to: currentPubId }));

                while (pendingIceCandidates.length) {
                    const ice = pendingIceCandidates.shift();
                    try {
                        await pc.addIceCandidate(ice);
                    } catch (e) {
                        console.warn("addIceCandidate(pending) failed", e, ice);
                    }
                }
            } catch (e) {
                console.error("handleOffer failed:", e);
            } finally {
                makingAnswer = false;
                if (pendingRemoteOffer) {
                    const next = pendingRemoteOffer;
                    pendingRemoteOffer = null;
                    handleOffer(next);
                }
            }
        };

        pc.ontrack = (e) => {
            const streamId = e.streams[0]?.id;
            const trackId = e.track.id;

            console.log(`Received track: kind=${e.track.kind}, id=${trackId}, streamId=${streamId}`);

            if (trackId === 'video-raw' || streamId === 'stream-raw') {
                document.getElementById('rawVideo').srcObject = e.streams[0];
            } else if (trackId === 'video-vs' || streamId === 'stream-vectorscope') {
                document.getElementById('vectorscopeVideo').srcObject = e.streams[0];
            } else if (trackId === 'video-wf' || streamId === 'stream-waveform') {
                document.getElementById('waveformVideo').srcObject = e.streams[0];
            } else {
                console.log(`Ignored track ${trackId} (${streamId})`);
            }
        };

        pc.onicecandidate = (e) => {
            if (e.candidate) {
                ws.send(JSON.stringify({
                    type: "candidate",
                    candidate: e.candidate.candidate,
                    mid: e.candidate.sdpMid,
                    sdpMLineIndex: e.candidate.sdpMLineIndex ?? 0,
                    to: currentPubId,
                }));
            }
        };

        pc.oniceconnectionstatechange = () => console.log("PC ICE State:", pc.iceConnectionState);
        pc.onconnectionstatechange = () => console.log("PC Connection State:", pc.connectionState);

        // --- WebSocket Listeners ---
        
        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            ws.send(JSON.stringify({ type: 'need-offer' }));
        };

        ws.onmessage = async (event) => {
            try {
                const text = typeof event.data === "string" ? event.data : await event.data.text();
                const data = JSON.parse(text);

                if (data.type === 'offer') {
                    console.log("Received WebRTC offer.");
                    currentPubId = data.from || currentPubId;
                    handleOffer(data.sdp);
                } else if (data.type === 'candidate') {
                    try {
                        const ice = {
                            candidate: data.candidate,
                            sdpMLineIndex: typeof data.sdpMLineIndex === "number" ? data.sdpMLineIndex : 0,
                            sdpMid: data.mid ?? null,
                        };
                        if (pc.remoteDescription) {
                            await pc.addIceCandidate(ice);
                        } else {
                            pendingIceCandidates.push(ice);
                        }
                    } catch (e) {
                        console.error("addIceCandidate failed", e, data);
                    }
                }
            } catch (e) {
                console.error('Error parsing message:', e);
            }
        };

        ws.onclose = () => {
            console.log('Disconnected from WebSocket server');
        };

        ws.onerror = error => {
            console.error('WebSocket Error:', error);
        };

        // --- Video Vectorscope Grid Drawing ---
        
        const videoVectorscopeCanvas = document.getElementById('videoVectorscopeGrid');
        if (videoVectorscopeCanvas) {
            const videoVsCtx = videoVectorscopeCanvas.getContext('2d');

            function drawVideoVectorscopeGrid() {
                const canvas = videoVectorscopeCanvas;
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                const ctx = videoVsCtx;
                const width = canvas.width;
                const height = canvas.height;

                ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                ctx.lineWidth = 1;
                ctx.clearRect(0, 0, width, height);

                // XY axes
                ctx.beginPath();
                ctx.moveTo(width / 2, 0);
                ctx.lineTo(width / 2, height);
                ctx.moveTo(0, height / 2);
                ctx.lineTo(width, height / 2);
                ctx.stroke();

                // Diagonal axes
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(width, height);
                ctx.moveTo(0, height);
                ctx.lineTo(width, 0);
                ctx.stroke();
            }

            const videoVsVideo = document.getElementById('vectorscopeVideo');
            videoVsVideo.addEventListener('playing', drawVideoVectorscopeGrid);
            window.addEventListener('resize', drawVideoVectorscopeGrid);
            drawVideoVectorscopeGrid();
        }
    </script>
</body>

</html>
